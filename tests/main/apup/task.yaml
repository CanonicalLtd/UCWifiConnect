summary: Test wifi-connect AP is enabled and has the ip that should

prepare: |
    # We need some tools for scanning etc.
    snap install wireless-tools
    snap connect wireless-tools:network-control core

execute: |
    systemctl stop snap.wifi-connect.daemon.service

    while systemctl status snap.wifi-connect.daemon.service ; do
        sleep 1
    done

    nmcli d set wlan0 managed n
    wifi-ap.config set disabled=false

    while wifi-ap.status | grep "ap.active: false" ; do
        sleep 0.5
    done

    ifconfig wlan1 up
    # enough time for wlan1 to be up
    sleep 5 
    # Scan for networks on the other side of the WiFi network
    # and ensure the network is available.
    wireless-tools.iw dev wlan1 scan | grep 'SSID: Ubuntu'

    # connect to that network and verify wlan1 did it
    /snap/bin/network-manager.nmcli d wifi connect Ubuntu
    /snap/bin/network-manager.nmcli d | grep 'wlan1.*connected'
